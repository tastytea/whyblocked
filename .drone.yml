pipeline:
  gcc6:
    image: debian:stretch-slim
    pull: true
    environment:
      - LANG=C.utf8
      - CXX=g++-6
      - CXXFLAGS=-pipe -O2
    commands:
      - rm /etc/apt/apt.conf.d/docker-clean
      - apt-get update -q
      - apt-get install -qy g++ cmake pkg-config
      - apt-get install -qy libvsqlitepp-dev libboost-dev libxdg-basedir-dev qt5-default qttools5-dev-tools qttools5-dev
      - apt-get install -qy dpkg-dev rpm file wget appstream
      - rm -rf build && mkdir -p build && cd build
      - cmake -DCMAKE_INSTALL_PREFIX=/usr ..
      - make VERBOSE=1
      - make install DESTDIR=install
      - make package
      - cmake -DWITH_DEB=ON ..
      - make package
      - cmake -DWITH_DEB=OFF -DWITH_RPM=ON ..
      - make package
      - sed -i 's/Version=1.1//' install/usr/share/applications/de.tastytea.Whyblocked.desktop
      - sed -i 's!<launchable.*</launchable>!!' install/usr/share/metainfo/de.tastytea.Whyblocked.appdata.xml
      - sed -i 's!Whyblocked</id>!Whyblocked.desktop</id>!' install/usr/share/metainfo/de.tastytea.Whyblocked.appdata.xml
      - sed -Ei 's!</?(screenshot|image).*!!' install/usr/share/metainfo/de.tastytea.Whyblocked.appdata.xml
      - mv install/usr/share/qt5/translations install/usr/
      - wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
      - chmod +x linuxdeploy-x86_64.AppImage
      - ./linuxdeploy-x86_64.AppImage --appimage-extract
      - mkdir linuxdeploy-qt && cd linuxdeploy-qt
      - wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
      - chmod +x linuxdeploy-plugin-qt-x86_64.AppImage
      - ./linuxdeploy-plugin-qt-x86_64.AppImage --appimage-extract
      - cd ..
      - ln -s linuxdeploy-qt/squashfs-root/AppRun linuxdeploy-plugin-qt
      - UPDATE_INFORMATION="zsync|https://appimages.schlomp.space/Whyblocked-x86_64.AppImage.zsync" ./squashfs-root/AppRun --appdir install --output appimage --plugin qt
    volumes:
      - /var/cache/debian-package-cache:/var/cache/apt/archives

  gcc7:
    image: debian:stretch-slim
    pull: true
    when:
      event: [push, pull_request]
    environment:
      - LANG=C.utf8
      - CXX=g++-7
      - CXXFLAGS=-pipe -O2
    commands:
      - rm /etc/apt/apt.conf.d/docker-clean
      - apt-get update -q
      - echo "APT::Default-Release \"stretch\";" >> /etc/apt/apt.conf.d/00default_release
      - echo "deb http://deb.debian.org/debian stretch-backports main" >> /etc/apt/sources.list.d/backports.list
      - echo "deb http://ppa.launchpad.net/ubuntu-toolchain-r/test/ubuntu xenial main" >> /etc/apt/sources.list.d/ubuntu-toolchain-r.list
      - apt-get install -qy gnupg
      - gpg --keyserver hkp://keyserver.ubuntu.com --recv-keys 0x60c317803a41ba51845e371a1e9377a2ba9ef27f
      - gpg --armor --export 0x60c317803a41ba51845e371a1e9377a2ba9ef27f | apt-key add -
      - apt-get update -q
      - apt-get install -qy -t xenial g++-7
      - apt-get install -qy cmake pkg-config
      - apt-get install -qy libvsqlitepp-dev libboost-dev libxdg-basedir-dev qt5-default qttools5-dev-tools qttools5-dev
      - rm -rf build && mkdir -p build && cd build
      - cmake ..
      - make VERBOSE=1
      - make install DESTDIR=install
    volumes:
      - /var/cache/debian-package-cache:/var/cache/apt/archives

  gcc8:
    image: debian:stretch-slim
    pull: true
    when:
      event: [push, pull_request]
    environment:
      - LANG=C.utf8
      - CXX=g++-8
      - CXXFLAGS=-pipe -O2
    commands:
      - rm /etc/apt/apt.conf.d/docker-clean
      - apt-get update -q
      - echo "APT::Default-Release \"stretch\";" >> /etc/apt/apt.conf.d/00default_release
      - echo "deb http://deb.debian.org/debian stretch-backports main" >> /etc/apt/sources.list.d/backports.list
      - echo "deb http://ppa.launchpad.net/ubuntu-toolchain-r/test/ubuntu xenial main" >> /etc/apt/sources.list.d/ubuntu-toolchain-r.list
      - apt-get install -qy gnupg
      - gpg --keyserver hkp://keyserver.ubuntu.com --recv-keys 0x60c317803a41ba51845e371a1e9377a2ba9ef27f
      - gpg --armor --export 0x60c317803a41ba51845e371a1e9377a2ba9ef27f | apt-key add -
      - apt-get update -q
      - apt-get install -qy -t xenial g++-8
      - apt-get install -qy cmake pkg-config
      - apt-get install -qy libvsqlitepp-dev libboost-dev libxdg-basedir-dev qt5-default qttools5-dev-tools qttools5-dev
      - rm -rf build && mkdir -p build && cd build
      - cmake ..
      - make VERBOSE=1
      - make install DESTDIR=install
    volumes:
      - /var/cache/debian-package-cache:/var/cache/apt/archives

  clang3:
    image: debian:stretch-slim
    pull: true
    when:
      event: [push, pull_request]
    environment:
      - LANG=C.utf8
      - CXX=clang++
      - CXXFLAGS=-pipe -O2
    commands:
      - rm /etc/apt/apt.conf.d/docker-clean
      - echo "APT::Default-Release \"stretch\";" >> /etc/apt/apt.conf.d/00default_release
      - echo "deb http://deb.debian.org/debian stretch-backports main" >> /etc/apt/sources.list.d/backports.list
      - apt-get update -q
      - apt-get install -qy clang cmake pkg-config
      - apt-get install -qy libvsqlitepp-dev libboost-dev libxdg-basedir-dev qt5-default qttools5-dev-tools qttools5-dev
      - rm -rf build && mkdir -p build && cd build
      - cmake ..
      - make VERBOSE=1
      - make install DESTDIR=install
    volumes:
      - /var/cache/debian-package-cache:/var/cache/apt/archives

  clang5:
    image: debian:stretch-slim
    pull: true
    when:
      event: [push, pull_request]
    environment:
      - LANG=C.utf8
      - CXX=clang++-5.0
      - CXXFLAGS=-pipe -O2
    commands:
      - rm /etc/apt/apt.conf.d/docker-clean
      - echo "APT::Default-Release \"stretch\";" >> /etc/apt/apt.conf.d/00default_release
      - echo "deb http://deb.debian.org/debian stretch-backports main" >> /etc/apt/sources.list.d/stretch.list
      - apt-get update -q
      - apt-get install -qy -t stretch-backports clang-5.0
      - apt-get install -qy cmake pkg-config
      - apt-get install -qy libvsqlitepp-dev libboost-dev libxdg-basedir-dev qt5-default qttools5-dev-tools qttools5-dev
      - rm -rf build && mkdir -p build && cd build
      - cmake ..
      - make VERBOSE=1
      - make install DESTDIR=install
    volumes:
      - /var/cache/debian-package-cache:/var/cache/apt/archives

  clang6:
    image: debian:stretch-slim
    pull: true
    when:
      event: [push, pull_request]
    environment:
      - LANG=C.utf8
      - CXX=clang++-6.0
      - CXXFLAGS=-pipe -O2
    commands:
      - rm /etc/apt/apt.conf.d/docker-clean
      - echo "APT::Default-Release \"stretch\";" >> /etc/apt/apt.conf.d/00default_release
      - echo "deb http://deb.debian.org/debian stretch-backports main" >> /etc/apt/sources.list.d/stretch.list
      - apt-get update -q
      - apt-get install -qy -t stretch-backports clang-6.0
      - apt-get install -qy cmake pkg-config
      - apt-get install -qy libvsqlitepp-dev libboost-dev libxdg-basedir-dev qt5-default qttools5-dev-tools qttools5-dev
      - rm -rf build && mkdir -p build && cd build
      - cmake ..
      - make VERBOSE=1
      - make install DESTDIR=install
    volumes:
      - /var/cache/debian-package-cache:/var/cache/apt/archives

  prepare_release:
    image: debian:jessie-slim
    pull: true
    when:
      event: tag
    commands:
      - cp -v build/whyblocked-${DRONE_TAG}_x86_64.tar.gz .
      - cp -v build/whyblocked_${DRONE_TAG}-0_amd64.deb .
      - cp -v build/whyblocked-${DRONE_TAG}-0.x86_64.rpm .
      - cp -v build/Whyblocked-x86_64.AppImage .
      - cp -v build/Whyblocked-x86_64.AppImage.zsync .

  gitea_release:
    image: plugins/gitea-release
    pull: true
    when:
      event: tag
    base_url: https://schlomp.space
    secrets: [ gitea_token ]
    title: ${DRONE_TAG}
    prerelease: true
    files:
      - whyblocked-${DRONE_TAG}_x86_64.tar.gz
      - whyblocked_${DRONE_TAG}-0_amd64.deb
      - whyblocked-${DRONE_TAG}-0.x86_64.rpm
      - Whyblocked-x86_64.AppImage
      - Whyblocked-x86_64.AppImage.zsync
    checksum:
      - sha256
      - sha512

  notify:
    image: drillster/drone-email
    pull: true
    host: cryptoparty-celle.de
    secrets: [ email_username, email_password ]
    from: drone@tzend.de
    when:
      status: [ changed, failure ]
